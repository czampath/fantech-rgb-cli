import json
import os

# Define the JSON file path
sourceJsonPath = r"path\test_all_data.json"

# Read data from the provided JSON file
with open(sourceJsonPath, 'r') as file:
    data = json.load(file)

# Given setup_data_list_off
setup_data_list_off = [
    {
        'data': '04ab0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    },
    {
        'data': 'f269c4e1abdad6b84302d3a50b39bf713c26b39be9e3789d315c5571b9f824545a7cabca162c2ae2513331bb3d44b4479782614f919d31b70f3e3e0415a6d41b'
    },
    {
        'data': '04020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    },
    {
        'data': '04130000000000001200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    },
    {
        'data': '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    },
    {
        'data': '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    },
    {
        'data': '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    },
    {
        'data': '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    },
    {
        'data': '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    },
    {
        'data': '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    },
    {
        'data': '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    },
    {
        'data': '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    },
    {
        'data': '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    },
    {
        'data': '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    },
    {
        'data': '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    },
    {
        'data': '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    },
    {
        'data': '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    },
    {
        'data': '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    },
    {
        'data': '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    },
    {
        'data': '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    },
    {
        'data': '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    },
    {
        'data': '0000000000000000000000000000aa55000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    },
    {
        'data': '04020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    },
    {
        'data': '04f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
    }
]

init_comm = '04ab0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
end_comm = '04f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'


# Extracting 'data' from each dictionary and creating a list
extracted_data = []

# Flag to indicate whether to start/stop extraction
start_extraction = False
for packet in data:

    data_fragment = packet['_source']['layers']['Setup Data']['usb.data_fragment']
    formatted_data = data_fragment.replace(':', '')
    
    # Start extraction when specific data is encountered
    if formatted_data == init_comm:
        start_extraction = True
    
    # Append data to the list if extraction flag is True
    if start_extraction:
        extracted_data.append(formatted_data)

    # Stop extraction when specific data is encountered
    if formatted_data == end_comm:
        start_extraction = False

count = len(extracted_data)
if(count == 24):
    print('Extraction successful')
    print("Count of items in the list:", count)
    print(extracted_data)

    # Save extracted data as a JSON file
    output_folder = 'hex'
    if not os.path.exists(output_folder):
        os.makedirs(output_folder)

    output_file = os.path.join(output_folder, os.path.basename(sourceJsonPath) + '.json')
    with open(output_file, 'w') as file:
        json.dump(extracted_data, file)

    print("Data extracted and saved successfully to:", output_file)
else:
    print('ERROR: Extraction failed!')
    preCount = len(setup_data_list_off)
    print("precount is: ",preCount)
    print("Count of items in the list:", count)
    print("first byte = ",extracted_data[0])
    print("last byte = ",extracted_data[-1])
